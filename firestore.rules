rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user email
    function getUserEmail() {
      return request.auth.token.email.lower();
    }
    
    // Helper function to check if user is owner or member of a family group
    function isOwnerOrMember(groupData) {
      return isAuthenticated() && (
        request.auth.uid == groupData.ownerUid ||
        getUserEmail() in groupData.memberEmails
      );
    }
    
    // Family Groups Collection
    match /familyGroups/{groupId} {
      // Anyone authenticated can read a group if they are owner or member
      allow read: if isAuthenticated() && isOwnerOrMember(resource.data);
      
      // Anyone authenticated can create a new group (they become owner)
      allow create: if isAuthenticated() 
        && request.resource.data.ownerUid == request.auth.uid
        && request.resource.data.ownerEmail == getUserEmail();
      
      // Only the owner can update or delete the group
      allow update: if isAuthenticated() 
        && request.auth.uid == resource.data.ownerUid
        // Ensure owner fields cannot be changed
        && request.resource.data.ownerUid == resource.data.ownerUid
        && request.resource.data.ownerEmail == resource.data.ownerEmail;
      
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.ownerUid;
    }
    
    // Shopping Items Collection
    match /shoppingItems/{itemId} {
      // Helper to get the family group document
      function getFamilyGroup(groupId) {
        return get(/databases/$(database)/documents/familyGroups/$(groupId)).data;
      }
      
      // Helper to check if user can access a specific group
      function canAccessGroup(groupId) {
        let group = getFamilyGroup(groupId);
        return isAuthenticated() && (
          request.auth.uid == group.ownerUid ||
          getUserEmail() in group.memberEmails
        );
      }
      
      // Read: User must be owner or member of the item's family group
      allow read: if canAccessGroup(resource.data.familyGroupId);
      
      // Create: User must be owner or member of the target family group
      allow create: if canAccessGroup(request.resource.data.familyGroupId)
        && request.resource.data.createdByUid == request.auth.uid;
      
      // Update: User must be owner or member of the item's family group
      // Cannot change familyGroupId or createdByUid
      allow update: if canAccessGroup(resource.data.familyGroupId)
        && request.resource.data.familyGroupId == resource.data.familyGroupId
        && request.resource.data.createdByUid == resource.data.createdByUid;
      
      // Delete: User must be owner or member of the item's family group
      allow delete: if canAccessGroup(resource.data.familyGroupId);
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
